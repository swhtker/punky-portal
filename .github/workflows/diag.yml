name: Diagnose punky.jspriggins.com routing
on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/diag.yml' ]
jobs:
  diag:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass
      - name: Run diagnostics on server
        env:
          SERVER_PASS: JKj3nhnaij3P
        run: |
          sshpass -p "$SERVER_PASS" ssh \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            root@49.12.236.136 bash -s << 'ENDSSH'
          echo "=== Running containers with jspriggins labels ==="
          docker ps --format "{{.Names}}|{{.Image}}|{{.Status}}" | while IFS="|" read name img status; do
            labels=$(docker inspect "$name" --format "{{range $k,$v := .Config.Labels}}$k=$v\n{{end}}" 2>/dev/null | grep -i "punky.jspriggins\|site.jspriggins\|api.jspriggins" | head -5)
            if [ -n "$labels" ]; then
              echo "CONTAINER: $name ($img) [$status]"
              echo "$labels"
              echo "---"
            fi
          done

          echo ""
          echo "=== Traefik routes for jspriggins.com ==="
          docker exec coolify-proxy traefik version 2>/dev/null || true
          docker exec traefik traefik version 2>/dev/null || true
          
          echo "=== All containers named *punky* or *site* ==="
          docker ps -a --format "{{.Names}}|{{.Status}}|{{.Ports}}" | grep -i "punky\|site\|portal" || echo "(none)"

          echo "=== bgwco0cgcsw4ws8w840cs0kg container ==="
          docker inspect bgwco0cgcsw4ws8w840cs0kg 2>/dev/null | python3 -c "
          import sys,json
          d=json.load(sys.stdin)
          if d:
              c=d[0]
              print('Name:', c.get('Name'))
              print('Status:', c.get('State',{}).get('Status'))
              nets = list(c.get('NetworkSettings',{}).get('Networks',{}).keys())
              print('Networks:', nets)
              labels = c.get('Config',{}).get('Labels',{})
              for k,v in labels.items():
                  if 'jspriggins' in v or 'traefik' in k.lower():
                      print(f'  {k}={v}')
          " 2>/dev/null || echo "(not found)"
          ENDSSH
