name: Restore punky-site (one-shot)
on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/site-restore.yml' ]

jobs:
  restore:
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Write fix script via Python
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          python3 -c "
          import os, textwrap
          pat = os.environ['GH_PAT']
          script = '''#!/bin/bash
          set -e
          DB=/data/coolify/database.sqlite
          UUID=ccoss8so04kksc4c80kwgg84
          NOW=$(date -u +\"%Y-%m-%d %H:%M:%S\")

          echo \"=== Schema ===\"
          docker exec coolify sqlite3 \"\$DB\" \".schema applications\" 2>/dev/null | head -80

          echo \"=== Purge stale row ===\"
          docker exec coolify sqlite3 \"\$DB\" \"DELETE FROM applications WHERE uuid='\$UUID';\" || true

          echo \"=== Insert ===\"
          docker exec coolify sqlite3 \"\$DB\" \"INSERT INTO applications (uuid,name,description,environment_id,destination_id,source_id,git_repository,git_branch,build_pack,base_directory,fqdn,status,created_at,updated_at) VALUES ('\$UUID','punky-site','Punky landing site',2,0,NULL,'https://'''+pat+'''@github.com/swhtker/punky-portal.git','main','dockerfile','/','https://punky.jspriggins.com,https://site.jspriggins.com','stopped','\$NOW','\$NOW');\"

          echo \"=== Verify ===\"
          docker exec coolify sqlite3 \"\$DB\" \"SELECT uuid,name,source_id,git_repository FROM applications WHERE uuid='\$UUID';\"
          '''
          with open('/tmp/fix.sh','w') as f:
              f.write(script)
          print('Script written')
          "

      - name: SCP and run on prod server
        env:
          SERVER_PASS: JKj3nhnaij3P
        run: |
          sshpass -p "$SERVER_PASS" scp \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            /tmp/fix.sh root@49.12.236.136:/tmp/fix.sh
          sshpass -p "$SERVER_PASS" ssh \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            root@49.12.236.136 "bash /tmp/fix.sh; rm -f /tmp/fix.sh"

      - name: Trigger Coolify deploy
        env:
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          sleep 4
          RESP=$(curl -s -X POST \
            "https://coolify.jspriggins.com/api/v1/deploy?uuid=ccoss8so04kksc4c80kwgg84&force=false" \
            -H "Authorization: Bearer $COOLIFY_TOKEN")
          echo "Deploy: $RESP"
