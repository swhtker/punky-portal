name: Remove stale smart-router manual container
on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/fix-manual.yml' ]
jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass
      - name: Remove stale -manual container
        env:
          SP: JKj3nhnaij3P
          SCRIPT_B64: "aW1wb3J0IHN1YnByb2Nlc3MsIGpzb24KCiMgRmluZCB0aGUgLW1hbnVhbCBjb250YWluZXIKcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWydkb2NrZXInLCAncHMnLCAnLXEnLCAnLS1maWx0ZXInLCAnbmFtZT1tOHdvZzRnNDg0MHMwY28wMGdzYzA4a2stbWFudWFsJ10sCiAgICBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUpCm1hbnVhbF9pZCA9IHJlc3VsdC5zdGRvdXQuc3RyaXAoKQpwcmludChmJ21hbnVhbCBjb250YWluZXIgaWQ6IHttYW51YWxfaWQhcn0nKQoKaWYgbWFudWFsX2lkOgogICAgIyBDaGVjayBpdHMgbGFiZWxzCiAgICByID0gc3VicHJvY2Vzcy5ydW4oWydkb2NrZXInLCAnaW5zcGVjdCcsIG1hbnVhbF9pZF0sIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSkKICAgIGQgPSBqc29uLmxvYWRzKHIuc3Rkb3V0KVswXQogICAgbGFiZWxzID0gZC5nZXQoJ0NvbmZpZycsIHt9KS5nZXQoJ0xhYmVscycsIHt9KQogICAgcHJpbnQoJ0xhYmVscyB3aXRoIHB1bmt5LmpzcHJpZ2dpbnM6JykKICAgIGZvciBrLCB2IGluIGxhYmVscy5pdGVtcygpOgogICAgICAgIGlmICdqc3ByaWdnaW5zJyBpbiB2OgogICAgICAgICAgICBwcmludChmJyAge2t9OiB7dn0nKQogICAgCiAgICAjIFN0b3AgYW5kIHJlbW92ZQogICAgcHJpbnQoJ1N0b3BwaW5nLi4uJykKICAgIHN1YnByb2Nlc3MucnVuKFsnZG9ja2VyJywgJ3N0b3AnLCBtYW51YWxfaWRdLCBjYXB0dXJlX291dHB1dD1UcnVlKQogICAgcHJpbnQoJ1JlbW92aW5nLi4uJykKICAgIHN1YnByb2Nlc3MucnVuKFsnZG9ja2VyJywgJ3JtJywgbWFudWFsX2lkXSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSkKICAgIHByaW50KCdEb25lIOKAlCBzdGFsZSAtbWFudWFsIGNvbnRhaW5lciByZW1vdmVkLicpCmVsc2U6CiAgICBwcmludCgnTm8gLW1hbnVhbCBjb250YWluZXIgZm91bmQgKGFscmVhZHkgcmVtb3ZlZD8pJykKCiMgVmVyaWZ5CnJlc3VsdDIgPSBzdWJwcm9jZXNzLnJ1bihbJ2RvY2tlcicsICdwcycsICctLWZpbHRlcicsICduYW1lPW04d29nNGc0ODQwczBjbzAwZ3NjMDhray1tYW51YWwnLCAnLS1mb3JtYXQnLCAne3suTmFtZXN9fSddLAogICAgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlKQpwcmludChmJ1JlbWFpbmluZzoge3Jlc3VsdDIuc3Rkb3V0LnN0cmlwKCkgb3IgIihub25lKSJ9Jyk="
        run: |
          echo "$SCRIPT_B64" | base64 -d > /tmp/fix.py
          sshpass -p "$SP" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/fix.py root@49.12.236.136:/tmp/fix.py
          sshpass -p "$SP" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@49.12.236.136 "python3 /tmp/fix.py; rm -f /tmp/fix.py"
