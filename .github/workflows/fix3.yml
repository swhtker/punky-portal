name: Fix Traefik file config for punky-site
on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/fix3.yml' ]
jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Write and run fix script
        env:
          SERVER_PASS: JKj3nhnaij3P
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          python3 -c "
          import os, subprocess, tempfile

          script = """
#!/bin/bash
set -e

echo '=== All running containers ==='
docker ps --format 'NAME={{.Names}} IMAGE={{.Image}} STATUS={{.Status}}'

echo ''
echo '=== Traefik file config directory ==='
PROXY_DIR=/data/coolify/proxy
find $PROXY_DIR -name '*.yml' -o -name '*.yaml' 2>/dev/null
ls -la $PROXY_DIR/ 2>/dev/null || true
ls -la $PROXY_DIR/dynamic/ 2>/dev/null || true

echo ''
echo '=== Traefik dynamic config files (first 200 lines) ==='
for f in $PROXY_DIR/dynamic/*.yml $PROXY_DIR/dynamic/*.yaml; do
  [ -f "$f" ] || continue
  echo "FILE: $f"
  cat "$f" | head -80
  echo '---'
done

echo ''
echo '=== Containers with traefik.enable label ==='
docker ps -q | xargs -I{} docker inspect {} --format 'CONTAINER={{.Name}} ENABLED={{index .Config.Labels "traefik.enable"}}' 2>/dev/null | grep -v 'ENABLED=<no'

echo ''
echo '=== Coolify proxy container inspection ==='
docker inspect coolify-proxy 2>/dev/null | python3 -c "
import sys,json
d=json.load(sys.stdin)
if d:
    c=d[0]
    print('State:', c.get('State',{}).get('Status'))
    mounts = c.get('Mounts',[])
    for m in mounts:
        print('Mount:', m.get('Source'), '->', m.get('Destination'))
    nets = list(c.get('NetworkSettings',{}).get('Networks',{}).keys())
    print('Networks:', nets)
" || echo '(no coolify-proxy)'
"""

          with open('/tmp/fix3.sh', 'w') as f:
              f.write(script)
          print('Script ready')
          "

          sshpass -p "$SERVER_PASS" scp \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            /tmp/fix3.sh root@49.12.236.136:/tmp/fix3.sh

          sshpass -p "$SERVER_PASS" ssh \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            root@49.12.236.136 "bash /tmp/fix3.sh; rm -f /tmp/fix3.sh"
