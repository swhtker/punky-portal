name: Inspect and fix manual smart-router container
on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/fix13.yml' ]
jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass
      - name: Inspect manual container and plan fix
        env:
          SP: JKj3nhnaij3P
          SCRIPT_B64: "aW1wb3J0IGpzb24sIHN1YnByb2Nlc3MsIHN5cwoKQ09OVEFJTkVSID0gJ204d29nNGc0ODQwczBjbzAwZ3NjMDhray1tYW51YWwnCgojIDEuIEluc3BlY3QgY3VycmVudCBzdGF0ZQpyID0gc3VicHJvY2Vzcy5ydW4oWydkb2NrZXInLCAnaW5zcGVjdCcsIENPTlRBSU5FUl0sIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSkKaWYgci5yZXR1cm5jb2RlICE9IDA6CiAgICBwcmludChmJ0NvbnRhaW5lciB7Q09OVEFJTkVSfSBub3QgZm91bmQ6IHtyLnN0ZGVycn0nKQogICAgc3lzLmV4aXQoMCkKCmQgPSBqc29uLmxvYWRzKHIuc3Rkb3V0KVswXQpwcmludCgnPT09IEN1cnJlbnQgY29uZmlnID09PScpCnByaW50KCdOYW1lOicsIGQuZ2V0KCdOYW1lJykpCnByaW50KCdJbWFnZTonLCBkLmdldCgnQ29uZmlnJyx7fSkuZ2V0KCdJbWFnZScpKQpwcmludCgnU3RhdHVzOicsIGQuZ2V0KCdTdGF0ZScse30pLmdldCgnU3RhdHVzJykpCm5ldHMgPSBsaXN0KGQuZ2V0KCdOZXR3b3JrU2V0dGluZ3MnLHt9KS5nZXQoJ05ldHdvcmtzJyx7fSkua2V5cygpKQpwcmludCgnTmV0d29ya3M6JywgbmV0cykKY21kID0gZC5nZXQoJ0NvbmZpZycse30pLmdldCgnQ21kJykgb3IgZC5nZXQoJ0NvbmZpZycse30pLmdldCgnRW50cnlwb2ludCcpCnByaW50KCdDbWQ6JywgY21kKQplbnYgPSBkLmdldCgnQ29uZmlnJyx7fSkuZ2V0KCdFbnYnLFtdKQpwcmludCgnRW52OicsIGVudls6NV0pCmJpbmRzID0gZC5nZXQoJ0hvc3RDb25maWcnLHt9KS5nZXQoJ0JpbmRzJyxbXSkKcHJpbnQoJ0JpbmRzOicsIGJpbmRzKQpwb3J0cyA9IGQuZ2V0KCdOZXR3b3JrU2V0dGluZ3MnLHt9KS5nZXQoJ1BvcnRzJyx7fSkKcHJpbnQoJ1BvcnRzOicsIHBvcnRzKQoKIyBDdXJyZW50IGxhYmVscwpsYWJlbHMgPSBkLmdldCgnQ29uZmlnJyx7fSkuZ2V0KCdMYWJlbHMnLHt9KQpwcmludCgnXG49PT0gQWxsIGxhYmVscyA9PT0nKQpmb3Igayx2IGluIHNvcnRlZChsYWJlbHMuaXRlbXMoKSk6CiAgICBpZiAndHJhZWZpaycgaW4gay5sb3dlcigpIG9yICdqc3ByaWdnaW5zJyBpbiB2OgogICAgICAgIHByaW50KGYnICB7a306IHt2fScpCgojIDIuIEJ1aWxkIG5ldyBsYWJlbHMgV0lUSE9VVCBwdW5reS5qc3ByaWdnaW5zLmNvbQpuZXdfbGFiZWxzID0ge30KZm9yIGssIHYgaW4gbGFiZWxzLml0ZW1zKCk6CiAgICAjIFNraXAgdGhlIHB1bmt5LXJvdXRlciBydWxlIGVudGlyZWx5IOKAlCB3aWxsIHJlcGxhY2UgaXQKICAgIGlmIGsgPT0gJ3RyYWVmaWsuaHR0cC5yb3V0ZXJzLnB1bmt5LXJvdXRlci5ydWxlJzoKICAgICAgICBuZXdfbGFiZWxzW2tdID0gIkhvc3QoYHJvdXRlci5qc3ByaWdnaW5zLmNvbWApIgogICAgICAgIHByaW50KGYnXG5GSVggbGFiZWw6IHtrfSA9PiB7bmV3X2xhYmVsc1trXX0nKQogICAgZWxzZToKICAgICAgICBuZXdfbGFiZWxzW2tdID0gdgoKcHJpbnQoJ1xuPT09IFBsYW4gPT09JykKcHJpbnQoJ1dpbGwgcmVjcmVhdGUgY29udGFpbmVyIHdpdGggcHVua3kuanNwcmlnZ2lucy5jb20gcmVtb3ZlZCBmcm9tIHB1bmt5LXJvdXRlciBydWxlJykKcHJpbnQoJ1RoaXMgdW5ibG9ja3MgcHVua3kuanNwcmlnZ2lucy5jb20gZm9yIHRoZSBzaXRlIGNvbnRhaW5lcicp"
        run: |
          echo "$SCRIPT_B64" | base64 -d > /tmp/inspect.py
          sshpass -p "$SP" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/inspect.py root@49.12.236.136:/tmp/inspect.py
          sshpass -p "$SP" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@49.12.236.136 "python3 /tmp/inspect.py; rm -f /tmp/inspect.py"
