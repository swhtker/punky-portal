name: Full container label audit
on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/fix12.yml' ]
jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass
      - name: Deploy and run audit script
        env:
          SP: JKj3nhnaij3P
          SCRIPT_B64: "aW1wb3J0IGpzb24sIHN1YnByb2Nlc3MsIHN5cwoKcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWydkb2NrZXInLCAncHMnLCAnLXEnXSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlKQpjb250YWluZXJzID0gcmVzdWx0LnN0ZG91dC5zdHJpcCgpLnNwbGl0KCkKcHJpbnQoZidUb3RhbCBjb250YWluZXJzOiB7bGVuKGNvbnRhaW5lcnMpfScpCgpmb3IgY2lkIGluIGNvbnRhaW5lcnM6CiAgICByID0gc3VicHJvY2Vzcy5ydW4oWydkb2NrZXInLCAnaW5zcGVjdCcsIGNpZF0sIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSkKICAgIGlmIG5vdCByLnN0ZG91dC5zdHJpcCgpOgogICAgICAgIGNvbnRpbnVlCiAgICB0cnk6CiAgICAgICAgZCA9IGpzb24ubG9hZHMoci5zdGRvdXQpWzBdCiAgICBleGNlcHQ6CiAgICAgICAgY29udGludWUKICAgIG5hbWUgPSBkLmdldCgnTmFtZScsICcnKQogICAgbGFiZWxzID0gZC5nZXQoJ0NvbmZpZycsIHt9KS5nZXQoJ0xhYmVscycsIHt9KQogICAgbmV0cyA9IGxpc3QoZC5nZXQoJ05ldHdvcmtTZXR0aW5ncycsIHt9KS5nZXQoJ05ldHdvcmtzJywge30pLmtleXMoKSkKICAgIGJhZCA9IHtrOiB2IGZvciBrLCB2IGluIGxhYmVscy5pdGVtcygpIGlmICdqc3ByaWdnaW5zJyBpbiB2fQogICAgaWYgYmFkOgogICAgICAgIHByaW50KGYnXG49PT0ge25hbWV9IG5ldHM9e25ldHN9ID09PScpCiAgICAgICAgZm9yIGssIHYgaW4gYmFkLml0ZW1zKCk6CiAgICAgICAgICAgIHByaW50KGYnICB7a306IHt2fScp"
        run: |
          echo "$SCRIPT_B64" | base64 -d > /tmp/audit.py
          sshpass -p "$SP" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /tmp/audit.py root@49.12.236.136:/tmp/audit.py
          sshpass -p "$SP" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@49.12.236.136 "python3 /tmp/audit.py; rm -f /tmp/audit.py"
